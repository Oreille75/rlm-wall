!function e(t,a,n){function s(o,r){if(!a[o]){if(!t[o]){var l="function"==typeof require&&require;if(!r&&l)return l(o,!0);if(i)return i(o,!0);var d=new Error("Cannot find module '"+o+"'");throw d.code="MODULE_NOT_FOUND",d}var c=a[o]={exports:{}};t[o][0].call(c.exports,function(e){var a=t[o][1][e];return s(a?a:e)},c,c.exports,e,t,a,n)}return a[o].exports}for(var i="function"==typeof require&&require,o=0;o<n.length;o++)s(n[o]);return s}({1:[function(e,t){var a=e("underscore"),n=e("jquery"),s=e("backbone"),i=e("backbone.marionette"),o=e("dateformat"),r=s.Model.extend({constructor:function(){s.Model.apply(this,arguments);var e=new Date(this.get("min_date"));e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),this.set("date",e,{silent:!0}),this.set("date_ts",e.getTime()),this.set("date_str",o(e,"dd/mm HH:MM"))}}),l=s.Collection.extend({model:r,url:"/api/stats",comparator:function(e){return-e.get("date_ts")}}),d=i.ItemView.extend({tagName:"tr",template:a.template('<td><%= date_str %></td><td><%= discarded %></td><td><%= twitter %></td><td><%= instagram %></td><td><%= total %></td><td><a href="#" class="go"><span class="fa fa-fw fa-step-backward"></span></a>&nbsp;<span class="fa fa-fw cmd-status"></span></td>'),ui:{go:"td a.go",cmdStatus:"td span.cmd-status"},events:{"click @ui.go":"onGo"},onGo:function(e){e.preventDefault(),this.trigger("stat:go")}}),c=i.CompositeView.extend({tagName:"table",className:"stats table table-striped",template:a.template('<thead><tr><th>Date</th><th><span class="fa fa-times"></span></th><th><span class="fa fa-twitter"></span></th><th><span class="fa fa-instagram"></span></th><th>Total</th><th><a href="#" class="go"><span class="fa fa-fw fa-fast-forward"></span></a>&nbsp;<span class="fa fa-fw cmd-status"></span></th></tr></thead><tbody class="data"></tbody>'),ui:{go:"th a.go",cmdStatus:"th span.cmd-status"},events:{"click @ui.go":"onGoLast"},childEvents:{"stat:go":"onGo"},childView:d,childViewContainer:"tbody.data",onGo:function(e){this.$el.find("span.cmd-status").removeClass("fa-check"),e.ui.cmdStatus.addClass("fa-spin fa-spinner"),n.post("/api/go",{date:e.model.get("date")}).then(function(){e.ui.cmdStatus.removeClass("fa-spin fa-spinner").addClass("fa-check")})},onGoLast:function(){this.$el.find("span.cmd-status").removeClass("fa-check"),this.ui.cmdStatus.addClass("fa-spin fa-spinner"),n.post("/api/go",{last:!0}).then(a.bind(function(){this.ui.cmdStatus.removeClass("fa-spin fa-spinner").addClass("fa-check")},this))}});t.exports={Stat:r,StatCollection:l,StatTableView:c,StatView:c}},{backbone:"backbone","backbone.marionette":"backbone.marionette",dateformat:4,jquery:"jquery",underscore:"underscore"}],2:[function(e,t){var a=e("jquery"),n=e("backbone"),s=e("underscore"),i=e("backbone.marionette"),o=n.Model.extend({idAttribute:"_id",defaults:{tag:"",running:!1,track_twitter:!0,track_instagram:!0,moderate:!0,scroll_speed:0,screen:"",timer_home:10,timer_zoom:10,timer_win:10,msg_win_home:"",msg_win_scr:"",blocked:"",followers:{}},url:"/api/globals"}),r=n.Model.extend({idAttribute:"_id",defaults:{message_id:null,date:null,ts:null,type:null,validated:null,discarded:null,special:"",img:null,txt:null,user:null,user_img:null},urlRoot:"/api/admin-messages",action:function(e){var t={};"discard"===e&&(t.discarded=!0,t.validated=!1,t.special=""),"undo-discard"===e?(t.discarded=!1,t.validated=!1,t.special=""):"validate"===e?(t.discarded=!1,t.validated=!0,t.special=""):("zoom"===e||"win"===e)&&(t.discarded=!1,t.validated=!0,t.special=e),this.set(t),this.save(t,{patch:!0})}}),l=n.Collection.extend({model:r,url:"/api/messages",sync:function(e,t,n){return"read"===e?a.getJSON(t.url).done(function(e){n.success(e)}).fail(function(){n.error()}):(console.error("not supported"),n.error(),null)},more:function(){if(0===this.length)return this.fetch();var e=this.at(this.length-1);return a.getJSON(this.url,{before_id:e.get("_id")}).done(s.bind(function(e){this.add(e)},this)).fail(function(e){console.log("fail",e)})}});l.comparators={dateAsc:function(e){return e.get("ts")},dateDesc:function(e){return-e.get("ts")}};var d=i.ItemView.extend({tagName:"div",className:"message",hashtag:"hashtag",template:s.template('<div class="inner">\n  <div class="user">\n    <span class="avatar"><%= userImage() %></span>\n    <span class="name"><%= user %></span>\n    <%= contentUser() %>\n  </div>\n  <div class="msg"><%= contentMsg() %></div>\n</div>\n'),onBeforeRender:function(){this.$el.addClass(this.model.get("type")),this.$el.attr("data-id",this.model.get("_id")),this.model.get("img")&&this.$el.addClass("has-figure")},templateHelpers:function(){var e=this;return{userImage:function(e){return"<img"+(e?' class="'+e+'"':"")+' src="'+this.user_img+'">'},image:function(){return this.img?'<div class="embed-responsive embed-responsive-1by1"><figure class="embed-responsive-item" style="background-image: url('+this.img+')"></div>':""},imageLow:function(){return this.img_low?'<div class="embed-responsive embed-responsive-1by1"><figure class="embed-responsive-item" style="background-image: url('+this.img_low+')"></div>':""},contentMsg:function(){return null!=this.img?this.image():this.text()},contentUser:function(){return null!=this.img?"<p>"+this.text()+"</p>":""},text:function(){var t=String(this.txt),a=e.getOption("hashtag"),n=new RegExp("#"+a,"i");return t=t.replace(/\s*http(s?):\/\/t.co\/[^/ ]*/g,""),t=t.replace(/(#\S+)/g,function(e,t){var s="hashtag";return t.match(n)&&(t="#"+a,s+=" self"),t.length>20&&(t=t.substr(0,20)+"..."),'<span class="'+s+'">'+t+"</span>"}),t=t.replace(/(@\S+)/g,'<span class="buddy">$1</span>')}}}});t.exports={Message:r,MessageCollection:l,MessageView:d,Globals:o}},{backbone:"backbone","backbone.marionette":"backbone.marionette",jquery:"jquery",underscore:"underscore"}],3:[function(e){var t=e("underscore"),a=e("jquery"),n=e("backbone");n.$=a;var s=e("backbone.marionette"),i=e("socket.io-client"),o=e("dateformat"),r=e("./common"),l=e("./admin-stats"),d=r.Message,c=r.MessageCollection,m=r.MessageView,u=r.Globals,h=a(window),g=a(document),p=m.extend({tagName:"div",className:"media message-admin",template:t.template('<div class="media-left user">\n  <%= userImage("media-object") %>\n  <span class="name"><%= user %></span>\n  <span class="date"><%= date() %></span>\n</div>\n<div class="media-body">\n  <%= mediaBody() %>\n</div>\n<div class="media-footer">\n  <%= actions() %>\n</div>\n'),events:{"click .media-footer button":"onActionClick"},modelEvents:{"change:discarded":"onModelChange","change:special":"onModelChange"},onBeforeRender:function(){this.$el.addClass(this.model.get("type")),this.$el.attr("data-id",this.model.get("_id")),this.model.get("validated")&&this.$el.attr("data-v",this.model.get("special")||"on"),this.model.get("discarded")?this.$el.addClass("discarded"):this.$el.removeClass("discarded")},onModelChange:function(){this.render()},templateHelpers:function(){var e=t.template('<button type="button" href="#<%= action %>" class="btn btn-action <%= action %>"><span class="fa fa-fw fa-<%= icon %>"></span></button>');return t.extend(m.prototype.templateHelpers.call(this),{date:function(){return o(new Date(this.ts),"dd/mm HH:MM:ss")},mediaBody:function(){var e=this.imageLow();return e?'<div class="row"><div class="col-sm-8"><p>'+this.text()+'</p></div><div class="col-sm-4">'+e+"</div></div>":'<div class="row"><div class="col-sm-12">'+this.text()+"</div></div>"},actions:function(){var a;a=this.discarded?[{action:"undo-discard",icon:"undo"}]:[{action:"discard",icon:"times"},{action:"validate",icon:"check"},{action:"zoom",icon:"star"},{action:"win",icon:"trophy"}];var n="";return t.each(a,function(t){n+=e(t)}),n}})},onActionClick:function(e){var t=a(e.currentTarget).attr("href").replace("#","");this.model.action(t)}}),f=s.CompositeView.extend({tagName:"div",className:"messages",ui:{messages:"section",header:"header",footer:"footer",more:"footer .more"},events:{"click @ui.more":"onMore"},template:t.template('<header></header>\n<section class="messages clearfix"></section>\n<footer>\n  <button type="button" class="btn btn-primary more"><span class="running-off fa fa-fw fa-arrow-down fa-fw"></span><span class="running-on fa fa-fw fa-spin fa-refresh"></span> Messages précédents</button>\n</footer>\n'),childView:p,childViewContainer:"section.messages",initialize:function(){this.listenTo(this,"layout:scroll",this.onScroll),this.moreRunning=!1},onRender:function(){this.collection.length?this.ui.more.show():this.ui.more.hide()},onMore:function(){this.moreRunning=!0,this.ui.more.prop("disabled",!0),this.ui.more.addClass("running"),this.collection.more().done(t.bind(function(e){this.ui.more.removeClass("running"),this.moreRunning=!1,0===e.length?this.ui.more.hide():this.ui.more.prop("disabled",!1)},this)).fail(function(){this.moreRunning=!1,this.ui.more.prop("disabled",!1),this.ui.more.removeClass("running")})},onScroll:function(e){!this.moreRunning&&e.bottom<300&&this.onMore()}}),v=s.ItemView.extend({tagName:"div",className:"config",ui:{inputs:"input, textarea"},events:{change:"onViewChange"},modelEvents:{change:"onModelChange"},template:t.template('<div class="row">\n  <div class="form-block col-sm-4">\n    <div class="form-group">\n      <label>Tag</label>\n      <div class="input-group">\n        <div class="input-group-addon">#</div>\n        <input class="form-control" type="text" name="tag" value="<%= tag %>">\n      </div>\n    </div>\n    <div class="form-group">\n      <%= checkbox(\'running\', \'Suivi actif\') %>\n      <%= checkbox(\'track_twitter\', \'- Twitter\') %>\n      <%= checkbox(\'track_instagram\', \'- Instagram\') %>\n    </div>\n    <div class="form-group">\n      <label>Modération</label>\n      <%= checkbox(\'moderate\', \'Modération active\') %>\n    </div>\n  </div>\n  <div class="form-block col-sm-4">\n    <div class="form-group">\n      <label>Vitesse</label>\n      <input class="form-control" name="scroll_speed" type="number" min="1" max="300" value="<%= scroll_speed %>">\n    </div>\n    <div class="form-group">\n      <label>Ecran</label>\n      <div class="radio">\n        <label>\n          <input type="radio" name="screen" value="auto"<%= (screen === \'auto\' ? \' checked="checked"\' : \'\') %>> Automatique\n        </label>\n      </div>\n      <div class="radio">\n        <label>\n          <input type="radio" name="screen" value="home"<%= (screen === \'home\' ? \' checked="checked"\' : \'\') %>> Accueil\n        </label>\n      </div>\n      <div class="radio">\n        <label>\n          <input type="radio" name="screen" value="wall"<%= (screen === \'wall\' ? \' checked="checked"\' : \'\') %>> Mur\n        </label>\n      </div>\n      <div class="radio">\n        <label>\n          <input type="radio" name="screen" value="zoom"<%= (screen === \'zoom\' ? \' checked="checked"\' : \'\') %>> Zoom\n        </label>\n      </div>\n    </div>\n  </div>\n  <div class="form-block col-sm-4">\n    <div class="form-group">\n      <label>Timer accueil</label>\n      <div class="input-group">\n        <input class="form-control" name="timer_home" type="number" min="1" max="300" value="<%= timer_home %>">\n        <div class="input-group-addon">s</div>\n      </div>\n    </div>\n    <div class="form-group">\n      <label>Timer zoom</label>\n      <div class="input-group">\n        <input class="form-control" name="timer_zoom" type="number" min="1" max="300" value="<%= timer_zoom %>">\n        <div class="input-group-addon">s</div>\n      </div>\n    </div>\n    <div class="form-group">\n      <label>Timer prix</label>\n      <div class="input-group">\n        <input class="form-control" name="timer_win" type="number" min="1" max="300" value="<%= timer_win %>">\n        <div class="input-group-addon">s</div>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="row">\n  <div class="form-block col-sm-4">\n    <div class="form-group">\n      <label>Message accueil</label>\n      <textarea class="form-control" rows="3" name="msg_win_home"><%= textarea_content(msg_win_home) %></textarea>\n    </div>\n  </div>\n  <div class="form-block col-sm-4">\n    <div class="form-group">\n      <label>Message écran prix</label>\n      <textarea class="form-control" rows="3" name="msg_win_scr"><%= textarea_content(msg_win_scr) %></textarea>\n    </div>\n  </div>\n  <div class="form-block col-sm-4">\n    <div class="form-group">\n      <label>Utilisateurs bloqués</label>\n      <textarea class="form-control" rows="3" name="blocked"><%= textarea_content(blocked) %></textarea>\n    </div>\n  </div>\n</div>\n'),templateHelpers:function(){return{checked:function(e){return this[e]?'checked="checked"':""},checkbox:function(e,t){return'<div class="checkbox"><label><input name="'+e+'" type="checkbox"'+(this[e]?' checked="checked"':"")+"> "+t+"</label></div>"},textarea_content:function(e){function t(e){return a[e]||e}var a={"&":"&amp;","<":"&lt;",">":"&gt;"};return e.replace(/[&<>]/g,t)}}},bindUIElements:function(){t.each(t.keys(this.model.toJSON()),function(e){this.ui.hasOwnProperty(e)||(this.ui[e]="[name="+e+"]")},this),s.ItemView.prototype.bindUIElements.call(this)},onViewChange:function(e){e.stopPropagation();var t,n=a(e.target),s=n.prop("tagName").toLowerCase(),i=n.attr("name"),o={};"input"===s&&(t=n.attr("type"),o[i]=n.prop("checkbox"===t?"checked":"value")),"textarea"===s&&(o[i]=n.val()),this.model.set(o),this.model.save(o,{patch:!0})},onShow:function(){this.model.get("running")?(this.ui.track_twitter.prop("disabled",!0),this.ui.track_instagram.prop("disabled",!0),this.ui.tag.prop("disabled",!0)):(this.ui.track_twitter.prop("disabled",!1),this.ui.track_instagram.prop("disabled",!1),this.ui.tag.prop("disabled",!1))},onModelChange:function(e){this._isShown&&(t.each(t.keys(e.changed),function(t){var a,n,s=this.ui[t];s&&s.length&&(a=s.prop("tagName").toLowerCase(),"input"===a&&(n=s.attr("type"),"checkbox"===n?s.prop("checked",e.changed[t]):"radio"===n?s.filter('[value="'+e.changed[t]+'"]').prop("checked",!0):s.prop("value",e.changed[t])),"textarea"===a&&s.val(e.changed[t]))},this),e.changed.hasOwnProperty("running")&&this.onShow())}}),b=new s.Application;b.locals=new n.Model({newMessages:0}),b.globals=new u,b.messages=new c,b.messages.url="/api/admin-messages",b.messages.comparator=c.comparators.dateDesc,b.validated=new c,b.validated.comparator=c.comparators.dateDesc,b.validated.url="/api/messages",b.stats=new l.StatCollection,b.addRegions({layout:"body"}),window.app=b;var y=s.LayoutView.extend({regions:{main:".main"},ui:{navItems:"nav li",navLinks:"nav li > a",badge:"nav .badge"},events:{"click @ui.navLinks":"onNav"},template:t.template('<nav class="navbar navbar-default navbar-fixed-top">\n  <div class="container">\n    <ul class="nav nav-pills">\n      <li id="nav-messages" class="active"><a href="#messages">\n        <span class="fa fa-fw fa-comments"></span>\n        <span class="badge" style="display: none"></span>\n      </a></li>\n      <li id="nav-validated"><a href="#validated">\n        <span class="fa fa-comment"></span>\n        <span class="fa fa-check"></span>\n      </a></li>\n      <li id="nav-config"><a href="#config">\n        <span class="fa fa-fw fa-cog"></span>\n      </a></li>\n      <li id="nav-stats"><a href="#stats">\n        <span class="fa fa-fw fa-line-chart"></span>\n      </a></li>\n    </ul>\n  </div>\n</nav>\n<div class="main container"></div>\n'),onShow:function(){a(window).on("scroll",t.debounce(t.bind(this.afterScroll,this),50)),b.locals.on("change:newMessages",t.bind(function(){var e=b.locals.get("newMessages");0===e?this.ui.badge.text("").hide():this.ui.badge.text(e).show()},this))},onNav:function(e){e.stopPropagation(),e.preventDefault();var t=a(e.currentTarget).attr("href");b.trigger("navigate",t)},setActiveMenu:function(e){this.ui.navItems.removeClass("active"),this.ui.navItems.filter("#nav-"+e).addClass("active")},afterScroll:function(){if(this.main.currentView){var e=h.scrollTop(),t=h.height(),a=g.height(),n=a-e-t;this.main.currentView.trigger("layout:scroll",{top:e,bottom:n})}}});b.pageViews={messages:new f({collection:b.messages}),validated:new f({collection:b.validated}),config:new v({model:b.globals}),stats:new l.StatView({collection:b.stats})},b.layoutView=new y;var w=s.AppRouter.extend({routes:{"":"messages",messages:"messages",validated:"validated",config:"config",stats:"stats"},onRoute:function(e){b.layoutView.setActiveMenu(e),b.layoutView.main.show(b.pageViews[e],{preventDestroy:!0})}});b.router=new w,b.addInitializer(function(){this.on("globals",function(e){this.globals.set(e)}),this.on("message",t.bind(function(e){var t=new d(e);t.get("validated")?(this.validated.add(t,{merge:!0}),this.messages.remove(t)):(this.validated.remove(t),this.messages.get(t)?this.messages.add(t,{merge:!0}):t.get("discarded")||this.locals.set("newMessages",this.locals.get("newMessages")+1))},this)),this.on("navigate",t.bind(function(e){var t=function(){window.location.reload()},a=e.replace("#","");"messages"===a&&(this.locals.set("newMessages",0),this.messages.fetch({error:t})),"validated"===a&&this.validated.fetch({error:t}),"stats"===a&&this.stats.fetch({error:t}),this.router.navigate(e,{trigger:!0}),h.scrollTop(0)},this))}),b.on("start",function(){var e=i.connect();e.on("connect",function(){e.emit("admin-handshake",{})}),e.on("reload",function(){window.location.reload()}),b.layout.show(b.layoutView),e.on("globals",function(e){b.trigger("globals",e)}),e.on("message",function(e){b.trigger("message",e)}),n.history.start({pushState:!0,root:"admin"})}),a.when(b.messages.fetch(),b.validated.fetch(),b.stats.fetch()).then(function(){b.start()})},{"./admin-stats":1,"./common":2,backbone:"backbone","backbone.marionette":"backbone.marionette",dateformat:4,jquery:"jquery","socket.io-client":"socket.io-client",underscore:"underscore"}],4:[function(e,t,a){!function(e){"use strict";function n(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}function s(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setDate(t.getDate()-(t.getDay()+6)%7+3);var a=new Date(t.getFullYear(),0,4);a.setDate(a.getDate()-(a.getDay()+6)%7+3);var n=t.getTimezoneOffset()-a.getTimezoneOffset();t.setHours(t.getHours()-n);var s=(t-a)/6048e5;return 1+Math.floor(s)}function i(e){var t=e.getDay();return 0===t&&(t=7),t}function o(e){return null===e?"null":void 0===e?"undefined":"object"!=typeof e?typeof e:Array.isArray(e)?"array":{}.toString.call(e).slice(8,-1).toLowerCase()}var r=function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,t=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,a=/[^-+\dA-Z]/g;return function(l,d,c,m){if(1!==arguments.length||"string"!==o(l)||/\d/.test(l)||(d=l,l=void 0),l=l||new Date,l instanceof Date||(l=new Date(l)),isNaN(l))throw TypeError("Invalid date");d=String(r.masks[d]||d||r.masks["default"]);var u=d.slice(0,4);("UTC:"===u||"GMT:"===u)&&(d=d.slice(4),c=!0,"GMT:"===u&&(m=!0));var h=c?"getUTC":"get",g=l[h+"Date"](),p=l[h+"Day"](),f=l[h+"Month"](),v=l[h+"FullYear"](),b=l[h+"Hours"](),y=l[h+"Minutes"](),w=l[h+"Seconds"](),k=l[h+"Milliseconds"](),M=c?0:l.getTimezoneOffset(),x=s(l),_=i(l),T={d:g,dd:n(g),ddd:r.i18n.dayNames[p],dddd:r.i18n.dayNames[p+7],m:f+1,mm:n(f+1),mmm:r.i18n.monthNames[f],mmmm:r.i18n.monthNames[f+12],yy:String(v).slice(2),yyyy:v,h:b%12||12,hh:n(b%12||12),H:b,HH:n(b),M:y,MM:n(y),s:w,ss:n(w),l:n(k,3),L:n(Math.round(k/10)),t:12>b?"a":"p",tt:12>b?"am":"pm",T:12>b?"A":"P",TT:12>b?"AM":"PM",Z:m?"GMT":c?"UTC":(String(l).match(t)||[""]).pop().replace(a,""),o:(M>0?"-":"+")+n(100*Math.floor(Math.abs(M)/60)+Math.abs(M)%60,4),S:["th","st","nd","rd"][g%10>3?0:(g%100-g%10!=10)*g%10],W:x,N:_};return d.replace(e,function(e){return e in T?T[e]:e.slice(1,e.length-1)})}}();r.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},r.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},"function"==typeof define&&define.amd?define(r):"object"==typeof a?t.exports=r:e.dateFormat=r}(this)},{}]},{},[3]);